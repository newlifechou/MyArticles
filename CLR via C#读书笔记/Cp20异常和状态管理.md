# Cp20 异常和状态管理
从这一章开始进入CLR的核心机制
## 定义异常
异常和错误的区别；
## 异常处理机制
基于Windows提供的异常处理机制；
try catch finally; 回溯调用栈；  
要注意关闭文件和链接语句放在finally中，以为不是每个错误都可以捕捉到的；  
## System.Exception类
其中StackTrack包含抛出异常前所有方法的名称和签名，对调试很有用；  
## FCL定义的异常类
很多很多
## 抛出异常
定义异常类型层次结构的时候，尽量让这个结构浅而宽。  
包含一条字符串信息；  
异常不要像用户显示，以免暴漏太多信息；  
自己设计异常一般来说没有必要；  
## 可靠性 vs 开发效率
这里一块涉及到后面章节的线程的内容；  
不追求完全可靠的代码因为不现实，主要是考虑效率；  
处理异常的代码要尽可能的简单，不要再抛出异常了，不然会让异常状态更加的复杂；  
如果异常确实比较严重，直接终止程序是最佳的选择；  
## 指导原则和最佳实践
类库开发人员一定不要去尝试修复状态，把尽可能多的异常呈献给应用开发者； 
## 善于使用finally
清理代码非常重要；使用lock，using和foerach语句的时候，编译器会自动创建trycatch；
## 不要什么都catch
不要写一个大小通吃的捕捉，要允许异常沿着调用栈向上传递；我经常这么干，汗颜！  
尽量捕捉具体的异常，不要捕捉和处理Exception；  
发生不可以恢复的异常的时候回滚部分操作保持状态； 
 Catch后不加任何东西表示捕获所有异常；throw后不加任何东西表示原样抛出捕获异常；  
 ## 未处理的异常
 ## 对异常进行调试
 ## 异常处理的性能问题
 ## 约束执行区域CER
 ## 代码契约
 
